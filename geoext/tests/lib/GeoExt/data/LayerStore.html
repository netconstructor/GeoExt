<!DOCTYPE html>
<html debug="true">
  <head>
    <script type="text/javascript" src="../../../../../openlayers/lib/OpenLayers.js"></script>
    <script type="text/javascript" src="../../../../../ext/adapter/ext/ext-base.js"></script>
    <script type="text/javascript" src="../../../../../ext/ext-all-debug.js"></script>
    <script type="text/javascript" src="../../../../lib/GeoExt.js"></script>

    <script type="text/javascript">
       
        function createMap() {
            var map = new OpenLayers.Map();
            return map;
        }

        function loadMapPanel() {
            var map = createMap();

            var mapPanel = new GeoExt.MapPanel({
                // panel options
                id: "map-panel",
                title: "GeoExt MapPanel",
                renderTo: "mappanel",
                height: 400,
                width: 600,
                // map panel-specific options
                map: map,
                center: new OpenLayers.LonLat(5, 45),
                zoom: 4
            });

            return mapPanel;
        }

        function test_constructor(t) {
            t.plan(3);

            var store, reader, map;

            store = new GeoExt.data.LayerStore();
            t.ok(store.reader instanceof GeoExt.data.LayerReader,
                 "ctor creates a layer reader if none is provided");

            reader = new Ext.data.ArrayReader();
            store = new GeoExt.data.LayerStore({reader: reader});
            t.ok(store.reader == reader,
                 "ctor sets the passed reader in the instance");

            map = new OpenLayers.Map();
            store = new GeoExt.data.LayerStore({map: map});
            t.ok(store.map == map,
                 "ctor sets the passed map in the instance");
        }

        function test_layerstore(t) {
            t.plan(6);

            var mapPanel = loadMapPanel();
            var map = mapPanel.map;

            var layer = new OpenLayers.Layer.Vector("Foo Layer");

            map.addLayer(layer);
            t.eq(map.layers.length, 1, "Adding layer to map does not create duplicate layers on map");
            t.eq(mapPanel.layers.getCount(), 1, "Adding layer to map does not create duplicate records in LayerStore");

            mapPanel.layers.remove(mapPanel.layers.getById(layer.id));
            t.eq(map.layers.length,0,"removeLayer on MapPanel's LayerStore removes layer from map");
            t.eq(mapPanel.layers.getCount(),0,"removeLayer on MapPanel's LayerStore removes layer from map");

            var reader = new GeoExt.data.LayerReader();
            mapPanel.layers.add((reader.readRecords([layer])).records);
            t.eq(map.layers.length,1,"Adding layer to MapPanel's LayerStore adds only one layer to map");
            t.eq(mapPanel.layers.getCount(),1,"Adding layers to MapPanel's LayerStore does not create duplicate layers"); 
        }
    </script>
  <body>
    <div id="mappanel"></div>
  </body>
</html>
