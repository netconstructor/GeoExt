<!DOCTYPE html>
<html debug="true">
  <head>
    <script type="text/javascript" src="../../../../../openlayers/lib/OpenLayers.js"></script>
    <script type="text/javascript" src="../../../../../ext/adapter/ext/ext-base.js"></script>
    <script type="text/javascript" src="../../../../../ext/ext-all.js"></script>
    <script type="text/javascript" src="../../../../lib/GeoExt.js"></script>

    <script type="text/javascript">

        function createMap() {
            var map = new OpenLayers.Map({allOverlays: true});
            var layer = new OpenLayers.Layer.WMS("test", '/ows', {layers: 'a'});
            map.addLayer(layer);
            return map;
        }

        function loadMapPanel() {
            var map = createMap();

            mapPanel = new GeoExt.MapPanel({
                // panel options
                id: "map-panel",
                title: "GeoExt MapPanel",
                renderTo: "mappanel",
                height: 400,
                width: 600,
                // map panel-specific options
                map: map,
                center: new OpenLayers.LonLat(5, 45),
                zoom: 4
            });

            return mapPanel;
        }

        function test_legendurl(t) {
            t.plan(1);
            var mapPanel = loadMapPanel();
            var lp  = new GeoExt.LegendPanel({
                renderTo: 'legendpanel'});
            lp.render();

            var newUrl = "http://www.geoext.org//trac/geoext/chrome/site/img/GeoExt.png";
            mapPanel.layers.getAt(0).set("legendURL", newUrl);

            var item = lp.getComponent(mapPanel.map.layers[0].id);
            var url = item.items.items[1].items.items[0].getEl().dom.src;
            t.eq(url, newUrl, "Update the image with the provided legendURL");

            lp.destroy();
            mapPanel.destroy();
        }

        function test_togglevisibility(t) {
            t.plan(2);
            var mapPanel = loadMapPanel();
            var lp  = new GeoExt.LegendPanel({
                renderTo: 'legendpanel'});
            lp.render();

            mapPanel.map.layers[0].setVisibility(false);
            var id = mapPanel.layers.getAt(0).get('layer').id;
            t.eq(lp.getComponent(id).hidden, true, "Layer has been hidden in legend");

            mapPanel.map.layers[0].setVisibility(true);
            t.eq(lp.getComponent(id).hidden, false, "Layer has been made visible again in legend");

            lp.destroy();
            mapPanel.destroy();
        }

        function test_hide(t) {
            t.plan(1);
            var mapPanel = loadMapPanel();
            var lp  = new GeoExt.LegendPanel({
                renderTo: 'legendpanel'});
            lp.render();

            mapPanel.layers.getAt(0).set("hideInLegend", true);
            var id = mapPanel.layers.getAt(0).get('layer').id;
            t.eq(lp.getComponent(id).hidden, true, "Layer has been hidden in legend");

            lp.destroy();
            mapPanel.destroy();
        }

        function test_dynamic(t) {
            t.plan(1);
            var mapPanel = loadMapPanel();
            var lp  = new GeoExt.LegendPanel({
                dynamic: false,
                renderTo: 'legendpanel'});
            lp.render();

            var layer;
            layer = new OpenLayers.Layer.WMS("test2", '/ows', {layers: 'b', format: 'image/png', transparent: 'TRUE'});
            mapPanel.map.addLayer(layer);

            t.eq(lp.items.length, 1, "If dynamic is false, do not add or remove layers from legend");

            lp.destroy();
            mapPanel.destroy();
        }

        function test_wms(t) {
            t.plan(1);
            var mapPanel = loadMapPanel();
            var lp  = new GeoExt.LegendPanel({
                renderTo: 'legendpanel'});
            lp.render();

            var item = lp.getComponent(mapPanel.map.layers[0].id);
            var url = item.items.items[1].items.items[0].url;
            var expectedUrl = "/ows?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetLegendGraphic&STYLES=&EXCEPTIONS=application%2Fvnd.ogc.se_xml&FORMAT=image%2Fgif&LAYER=a";
            t.eq(url, expectedUrl, "GetLegendGraphic url is generated correctly");

            lp.destroy();
            mapPanel.destroy();
        }

        function test_addremove(t) {
            t.plan(4);
            var mapPanel = loadMapPanel();
            var lp  = new GeoExt.LegendPanel({
                renderTo: 'legendpanel'});
            lp.render();
            t.eq(lp.items.length, 1, "Same number of layers in legend panel and in map");

            var item = lp.getComponent(mapPanel.map.layers[0].id);

            var layer;
            layer = new OpenLayers.Layer.WMS("test2", '/ows', {layers: 'b', format: 'image/png', transparent: 'TRUE'});
            mapPanel.map.addLayer(layer);

            t.eq(lp.items.length, 2, "New WMS layer has been added");

            layer = new OpenLayers.Layer.WMS("test3", '/ows', {layers: 'c'}, {visibility: false});
            mapPanel.map.addLayer(layer);

            t.eq(lp.items.length, 3, "A non visible WMS layer will be added but will be invisible");

            mapPanel.map.removeLayer(mapPanel.map.layers[0]);
            t.eq(lp.items.length, 2, "Removing the WMS layer really removes the legend from the panel");

            lp.destroy();
            mapPanel.destroy();
        }

    </script>
  <body>
    <div id="legendpanel"></div>
    <div id="mappanel"></div>
  </body>
</html>
